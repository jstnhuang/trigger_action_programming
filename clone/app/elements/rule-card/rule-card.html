<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../action-chooser/action-chooser.html">
<link rel="import" href="../daily-time-trigger/daily-time-trigger.html">
<link rel="import" href="../step-count/step-count.html">
<link rel="import" href="../switch-lights-action/switch-lights-action.html">
<link rel="import" href="../trigger-chooser/trigger-chooser.html">

<polymer-element name="rule-card" attributes="triggers action mode">
  <template>
    <link rel="stylesheet" href="rule-card.css">
    <link rel="stylesheet" href="../creator.css">
    <template if="{{mode == 'update'}}">
      <core-collapse id="updateCollapse">
        <span class="preview">If <a class="changeable" on-click="{{chooseTrigger}}">this</a> then that</span>
        <core-collapse id="triggerChooserCollapse">
          <step-count current="1" total="5"></step-count>
          <trigger-chooser triggers="{{TRIGGER_MODELS}}" on-trigger-selected="{{customizeTrigger}}"></trigger-chooser>
        </core-collapse>
        <core-collapse id="triggerOptionsCollapse">
          <step-count current="2" total="5"></step-count>
          <template if="{{selectedTriggerKey == 'daily_time'}}">
            <daily-time-trigger id="triggerOptions"></daily-time-trigger>
          </template>
          <paper-button raised on-click="{{chooseAction}}">Next step</paper-button>
        </core-collapse>
        <core-collapse id="chooseActionCollapse">
          <step-count current="3" total="5"></step-count>
          <action-chooser actions="{{ACTION_MODELS}}" on-action-selected="{{customizeAction}}"></action-chooser>
        </core-collapse>
        <core-collapse id="actionOptionsCollapse">
          <step-count current="4" total="5"></step-count>
          <template if="{{actionKey == 'switch_lights'}}">
            <switch-lights-action id="actionOptions"></switch-lights-action>
          </template>
          <paper-button raised on-click="{{confirmRule}}">Next step</paper-button>
        </core-collapse>
        <core-collapse id="ruleConfirmationCollapse">
          <step-count current="5" total="5"></step-count>
          <div class="ruleDesc">
            <span class="ifThenSection">
              If <span class="taChip">{{selectedTriggerDisplay}}</span>
            </span>
            <span class="ifThenSection">
              then <span class="taChip">{{actionDisplay}}</span>
            </span>
          </div>
          <p>You can go back to previous steps to make changes. Otherwise, click "Finish" to make this rule.</p>
          <paper-button raised on-click="{{saveRule}}">Finish</paper-button>
        </core-collapse>
      </core-collapse>
    </template>
    <template if="{{mode == 'summary'}}">
      <div class="ruleDesc">
        <template repeat="{{trigger, index in triggers}}">
          <span class="ifThenSection">
            <template if="{{index == 0}}">
              If
            </template>
            <template if="{{index != 0}}">
              and
            </template>
            <span class="taChip">{{trigger.displayName}}</span>
          </span>
        </template>
        <span class="ifThenSection">
          then <span class="taChip">{{action.displayName}}</span>
        </span>
      </div>
    </template>
  </template>
  <script>
    (function () {
      Polymer({
        mode: 'summary',
        triggers: [], // A list of trigger models for this rule, as JSON objects.
        action: {}, // The action as a JSON object.
        selectedTriggerKey: '', // The key of the currently selected trigger in the update interface.
        selectedTriggerDisplay: '', // The currently selected trigger in the update interface.
        actionKey: '',
        actionDisplay: '',

        ready: function() {
          // Core-collapse dynamically sets its overflow value to hidden. This interferes with
          // paper-dropdown, so we dynamically set the overflow to visible after the animation
          // for every core-collapse in the element.
          this.changeCollapseStyle(this.$.updateCollapse);
          this.changeCollapseStyle(this.$.triggerChooserCollapse);
          this.changeCollapseStyle(this.$.triggerOptionsCollapse);
          this.changeCollapseStyle(this.$.chooseActionCollapse);
          this.changeCollapseStyle(this.$.actionOptionsCollapse);
          this.changeCollapseStyle(this.$.ruleConfirmationCollapse);
        },

        // Sets the given core-collapse's style to overflow: visible after it has finished opening.
        changeCollapseStyle: function(collapse) {
          if (collapse === undefined) {
            return;
          }
          collapse.addEventListener('core-resize', function() {
            collapse.style.overflow = 'visible';
          });
        },

        modeChanged: function() {
          this.async(function() {
            this.$.updateCollapse.toggle();
          }, null, 50);
        },

        chooseTrigger: function() {
          this.async(function() {
            this.$.triggerChooserCollapse.opened = true;
          }, null, 50);
        },

        customizeTrigger: function(e, detail) {
          this.selectedTriggerKey = detail['key'];
          this.selectedTriggerDisplay = detail['displayName'];
          this.async(function() {
            this.$.triggerOptionsCollapse.opened = true;
          }, null, 50);
        },

        chooseAction: function() {
          if (!this.validateTrigger()) {
            return;
          }
          this.async(function() {
            this.$.chooseActionCollapse.opened = true;
          }, null, 50);
        },

        customizeAction: function(e, detail) {
          this.actionKey = detail['key'];
          this.actionDisplay = detail['displayName'];
          this.async(function() {
            this.$.actionOptionsCollapse.opened = true;
          }, null, 50);
        },

        confirmRule: function() {
          if (!this.validateAction()) {
            return;
          }
          this.async(function() {
            this.$.ruleConfirmationCollapse.opened = true;
          }, null, 50);
        },

        saveRule: function() {
          if (!this.validateTrigger()) {
            return;
          }
          if (!this.validateAction()) {
            return;
          }
          var triggerOptions = this.$.triggerOptionsCollapse.querySelector('#triggerOptions');
          this.triggers = [{
            key: this.selectedTriggerKey,
            displayName: this.selectedTriggerDisplay,
            params: triggerOptions.toJsonObject()
          }];
          var actionOptions = this.$.actionOptionsCollapse.querySelector('#actionOptions');
          this.action = {
            key: this.actionKey,
            displayName: this.actionDisplay,
            params: actionOptions.toJsonObject()
          };
          console.log(this.toJsonObject());
        },

        // Returns the representation of this rule in a JSON-serializable format.
        // Format:
        // {
        //   triggers: [
        //     {
        //       name: 'daily_time',
        //       params: { ... }
        //     }
        //   ],
        //   action: {
        //     name: 'switch_lights',
        //     params: { ... }
        //   }
        // }
        toJsonObject: function() {
          return {
            triggers: this.triggers,
            action: this.action
          };
        },

        validateTrigger: function() {
          var trigger = this.$.triggerOptionsCollapse.querySelector('#triggerOptions');
          var vr = trigger.validate();
          if (!vr.isValid) {
            alert(vr.message);
            return false;
          }
          return true;
        },

        validateAction: function() {
          var action = this.$.actionOptionsCollapse.querySelector('#actionOptions');
          var vr = action.validate();
          if (!vr.isValid) {
            alert(vr.message);
            return false;
          }
          return true;
        },

        TRIGGER_MODELS: [
          {
            key: 'daily_time',
            displayName: 'Daily time',
            description: 'Makes your rule run every day at a certain time, or between two times.'
          },
          {
            key: 'weather',
            displayName: 'Weather',
            description: 'Makes your rule run when the outside temperature is in some range, or if some condition like rain occurs.'
          },
          {
            key: 'doorbell_rings',
            displayName: 'Doorbell rings',
            description: 'Makes your rule run when the doorbell rings in your house.'
          },
          {
            key: 'my_location',
            displayName: 'My location',
            description: 'Makes your rule run when you arrive, leave, or are currently at home or work.'
          },
        ],
        ACTION_MODELS: [
          {
            key: 'switch_lights',
            displayName: 'Switch lights',
            description: 'Switches the lights in your house on or off.'
          },
          {
            key: 'brew_coffee',
            displayName: 'Brew coffee',
            description: 'Brews one or more pots of coffee.'
          },
          {
            key: 'set_thermostat',
            displayName: 'Set thermostat',
            description: 'Sets the thermostat to some temperature.'
          },
          {
            key: 'send_email',
            displayName: 'Send email',
            description: 'Sends an email notification to yourself.'
          },
        ]
      });
    })();
  </script>
</polymer-element>
