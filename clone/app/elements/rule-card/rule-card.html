<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../action-chooser/action-chooser.html">
<link rel="import" href="../daily-time-trigger/daily-time-trigger.html">
<link rel="import" href="../step-count/step-count.html">
<link rel="import" href="../trigger-chooser/trigger-chooser.html">

<polymer-element name="rule-card" attributes="triggers action mode">
  <template>
    <link rel="stylesheet" href="rule-card.css">
    <link rel="stylesheet" href="../creator.css">
    <template if="{{mode == 'update'}}">
      <core-collapse id="updateCollapse">
        <span class="preview">If <a class="changeable" on-click="{{chooseTrigger}}">this</a> then that</span>
        <core-collapse id="chooseTrigger">
          <step-count current="1" total="5"></step-count>
          <trigger-chooser triggers="{{TRIGGER_MODELS}}" on-trigger-selected="{{customizeTrigger}}"></trigger-chooser>
        </core-collapse>
        <core-collapse id="triggerOptions">
          <step-count current="2" total="5"></step-count>
          <template if="{{selectedTrigger == 'daily_time'}}">
            <daily-time-trigger></daily-time-trigger>
          </template>
          <paper-button raised on-click="{{chooseAction}}">Next step</paper-button>
        </core-collapse>
        <core-collapse id="chooseAction">
          <step-count current="3" total="5"></step-count>
          <action-chooser on-action-selected="{{customizeAction}}"></action-chooser>
        </core-collapse>
        <core-collapse id="actionOptions">
          <step-count current="4" total="5"></step-count>
          <p>Action options</p>
          <paper-button raised on-click="{{confirmRule}}">Next step</paper-button>
        </core-collapse>
        <core-collapse id="ruleConfirmation">
          <step-count current="5" total="5"></step-count>
          <div class="ruleDesc">
          <span class="ifThenSection">
            If <span class="taChip">{{selectedTrigger}}</span>
          </span>
          <span class="ifThenSection">
            then <span class="taChip">{{action}}</span>
          </span>
          </div>
          <p>You can go back to previous steps to make changes. Otherwise, click "Finish" to make this rule.</p>
          <paper-button raised on-click="{{saveRule}}">Finish</paper-button>
        </core-collapse>
      </core-collapse>
    </template>
    <template if="{{mode == 'summary'}}">
      <div class="ruleDesc">
        <template repeat="{{trigger, index in triggers}}">
          <span class="ifThenSection">
            <template if="{{index == 0}}">
              If
            </template>
            <template if="{{index != 0}}">
              and
            </template>
            <span class="taChip">{{trigger}}</span>
          </span>
        </template>
        <span class="ifThenSection">
          then <span class="taChip">{{action}}</span>
        </span>
      </div>
    </template>
  </template>
  <script>
    (function () {
      Polymer({
        mode: 'summary',
        selectedTrigger: '', // The currently selected trigger in the update interface.
        action: '',

        ready: function() {
          // Core-collapse dynamically sets its overflow value to hidden. This interferes with
          // paper-dropdown, so we dynamically set the overflow to visible after the animation
          // for every core-collapse in the element.
          this.changeCollapseStyle(this.$.updateCollapse);
          this.changeCollapseStyle(this.$.chooseTrigger);
          this.changeCollapseStyle(this.$.triggerOptions);
          this.changeCollapseStyle(this.$.chooseAction);
          this.changeCollapseStyle(this.$.ruleConfirmation);
        },

        // Sets the given core-collapse's style to overflow: visible after it has finished opening.
        changeCollapseStyle: function(collapse) {
          if (collapse === undefined) {
            return;
          }
          collapse.addEventListener('core-resize', function() {
            collapse.style.overflow = 'visible';
          });
        },

        modeChanged: function() {
          this.async(function() {
            this.$.updateCollapse.toggle();
          }, null, 50);
        },

        chooseTrigger: function() {
          this.async(function() {
            this.$.chooseTrigger.opened = true;
          }, null, 50);
        },

        customizeTrigger: function(e, detail) {
          this.selectedTrigger = detail;
          this.async(function() {
            this.$.triggerOptions.opened = true;
          }, null, 50);
        },

        chooseAction: function() {
          this.async(function() {
            this.$.chooseAction.opened = true;
          }, null, 50);
        },

        customizeAction: function(e, detail) {
          this.action = detail;
          this.async(function() {
            this.$.actionOptions.opened = true;
          }, null, 50);
        },

        confirmRule: function() {
          this.async(function() {
            this.$.ruleConfirmation.opened = true;
          }, null, 50);
        },

        TRIGGER_MODELS: [
          {
            key: 'daily_time',
            display_name: 'Daily time',
            description: 'Makes your rule run every day at a certain time, or between two times.'
          },
          {
            key: 'weather',
            display_name: 'Weather',
            description: 'Makes your rule run when the outside temperature is in some range, or if some condition like rain occurs.'
          },
          {
            key: 'doorbell_rings',
            display_name: 'Doorbell rings',
            description: 'Makes your rule run when the doorbell rings in your house.'
          },
          {
            key: 'my_location',
            display_name: 'My location',
            description: 'Makes your rule run when you arrive, leave, or are currently at home or work.'
          },
        ],
      });
    })();
  </script>
</polymer-element>
