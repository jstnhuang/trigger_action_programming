<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-animated-pages/transitions/slide-up.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../action-chooser/action-chooser.html">
<link rel="import" href="../step-count/step-count.html">
<link rel="import" href="../switch-lights-action/switch-lights-action.html">
<link rel="import" href="../trigger-builder/trigger-builder.html">

<polymer-element name="rule-card" attributes="triggers action mode index">
  <template>
    <link rel="stylesheet" href="rule-card.css">
    <link rel="stylesheet" href="../creator.css">
    <!-- Display a create/update interface -->
    <template if="{{mode == 'create' || mode == 'update'}}">
      <core-collapse id="updateCollapse">
        <template if="{{mode == 'create'}}">
          <span class="preview">If <a class="changeable" on-click="{{chooseTrigger}}" title="Click to start making the rule.">this</a> then that</span>
        </template>
        <template if="{{mode == 'update'}}">
          <div class="ruleDesc">
            <template repeat="{{trigger, index in triggers}}">
              <span class="ifThenSection">
                <template if="{{index == 0}}">
                  If
                </template>
                <template if="{{index != 0}}">
                  and
                </template>
                <span class="taChip">{{trigger.displayName}}</span>
              </span>
            </template>
            <span class="ifThenSection">
              then <span class="taChip">{{action.displayName}}</span>
            </span>
          </div>
        </template>
        <!-- Choose one or more triggers -->
        <div id="triggerBuilders">
          <template repeat="{{trigger, index in triggers}}">
            <trigger-builder mode="{{mode}}" TRIGGERMODELS="{{TRIGGER_MODELS}}" trigger="{{trigger}}" triggerIndex="{{index}}" currentTriggers="{{triggers}}" on-add-trigger="{{addTrigger}}" on-choose-action="{{chooseAction}}" on-delete-trigger="{{deleteTrigger}}"></trigger-builder>
          </template>
        </div>
        <!-- Choose an action -->
        <core-collapse class="stepCollapse" id="chooseActionCollapse">
          <step-count current="{{3 * triggers.length + 1}}" total="{{3 * triggers.length + 3}}"></step-count>
          <action-chooser selected="{{action.key}}" actions="{{ACTION_MODELS}}" on-action-selected="{{customizeAction}}"></action-chooser>
        </core-collapse>
        <core-collapse class="stepCollapse" id="actionOptionsCollapse">
          <step-count current="{{3 * triggers.length + 2}}" total="{{3 * triggers.length + 3}}"></step-count>
          <template if="{{action.key == 'switch_lights'}}">
            <switch-lights-action id="actionOptions" params="{{action.params}}"></switch-lights-action>
          </template>
          <paper-button class="next" raised on-click="{{confirmRule}}" title="You will have a chance to confirm your rule in the next step.">Next step</paper-button>
        </core-collapse>
        <!-- Confirm and save rule -->
        <core-collapse class="stepCollapse" id="ruleConfirmationCollapse">
          <step-count current="{{3 * triggers.length + 3}}" total="{{3 * triggers.length + 3}}"></step-count>
          <p>This is a preview of your rule. You can go back to previous steps if you want to make changes. Otherwise, click "Finish" to save this rule.</p>
          <div class="ruleDesc">
            <template repeat="{{trigger, index in triggers}}">
              <span class="ifThenSection">
                <template if="{{index == 0}}">
                  If
                </template>
                <template if="{{index != 0}}">
                  and
                </template>
                <span class="taChip">{{trigger.displayName}}</span>
              </span>
            </template>
            <span class="ifThenSection">
              then <span class="taChip">{{action.displayName}}</span>
            </span>
          </div>
          <paper-button class="next" raised on-click="{{saveRule}}" title="Click to save your rule.">Finish</paper-button>
        </core-collapse>
        <div layout horizontal end-justified>
          <paper-button raised class="deleteButton" on-click="{{delete}}" title="Click to delete this rule immediately.">
            <template if="{{mode == 'create'}}">
              Cancel rule
            </template>
            <template if="{{mode == 'update'}}">
              Delete rule
            </template>
          </paper-button>
        </div>
      </core-collapse>
    </template>
    <!-- Display a read-only summary of the rule. -->
    <template if="{{mode == 'summary'}}">
      <div class="ruleDesc">
        <template repeat="{{trigger, index in triggers}}">
          <span class="ifThenSection">
            <template if="{{index == 0}}">
              If
            </template>
            <template if="{{index != 0}}">
              and
            </template>
            <span class="taChip">{{trigger.displayName}}</span>
          </span>
        </template>
        <span class="ifThenSection">
          then <span class="taChip">{{action.displayName}}</span>
        </span>
      </div>
    </template>
  </template>
  <script>
    (function () {
      Polymer({
        mode: 'summary',
        triggers: [], // A list of trigger models for this rule, as JSON objects.
        action: {}, // The action as a JSON object.

        ready: function() {
          if (this.mode == 'update') {
            this.async(this.$.updateCollapse, function() {
              this.$.updateCollapse.opened = true;
            }, null, 100);
            this.async(function() {
              this.$.chooseActionCollapse.opened = true;
            }, null, 100);
            this.async(function() {
              this.$.actionOptionsCollapse.opened = true;
            }, null, 100);
            this.async(function() {
              this.$.ruleConfirmationCollapse.opened = true;
            }, null, 100);
          }
          // Core-collapse dynamically sets its overflow value to hidden. This interferes with
          // paper-dropdown, so we dynamically set the overflow to visible after the animation
          // for every core-collapse in the element.
          
          this.changeCollapseStyle(this.$.updateCollapse);
          this.changeCollapseStyle(this.$.chooseActionCollapse);
          this.changeCollapseStyle(this.$.actionOptionsCollapse);
          this.changeCollapseStyle(this.$.ruleConfirmationCollapse);
        },

        // Sets the given core-collapse's style to overflow: visible after it has finished opening.
        changeCollapseStyle: function(collapse) {
          if (collapse === undefined) {
            return;
          }
          collapse.addEventListener('core-resize', function() {
            collapse.style.overflow = 'visible';
          });
        },

        modeChanged: function() {
          if (this.$.updateCollapse !== null) {
            this.async(function() {
              this.$.updateCollapse.toggle();
            }, null, 50);
          }
        },

        chooseTrigger: function() {
          var builders = this.$.triggerBuilders.querySelectorAll('trigger-builder');
          for(var i=0; i<builders.length; ++i) {
            builders[i].chooseTrigger();
          }
        },

        addTrigger: function(e, triggers) {
          this.triggers = triggers.slice();
          this.triggers.push({});
          // TODO: see if you can use onMutation throughout instead of async.
          this.onMutation(this.$.triggerBuilders, function() {
            this.chooseTrigger();
          });
        },

        deleteTrigger: function(e, detail, sender) {
          var builders = this.$.triggerBuilders.querySelectorAll('trigger-builder');
          // If there is no next trigger, reset the selected state of the previous
          // trigger.
          if (detail.index == this.triggers.length - 1 && detail.index - 1 >= 0) {
            // If the action chooser is already open, then select the "that" option.
            if (this.$.chooseActionCollapse.opened) {
              builders[detail.index - 1].selectAddAction();
            } else {
              builders[detail.index - 1].unselect();
            }
          }
          this.triggers.splice(detail.index, 1);
        },

        chooseAction: function(e, triggers) {
          this.triggers = triggers.slice();
          if (!this.validateTriggers()) {
            return;
          }
          this.async(function() {
            this.$.chooseActionCollapse.opened = true;
          }, null, 50);
        },

        customizeAction: function(e, detail) {
          this.action.key = detail['key'];
          this.action.displayName = detail['displayName'];
          this.async(function() {
            this.$.actionOptionsCollapse.opened = true;
          }, null, 50);
        },

        confirmRule: function() {
          if (!this.validateAction()) {
            return;
          }
          this.async(function() {
            this.$.ruleConfirmationCollapse.opened = true;
          }, null, 50);
        },

        saveRule: function() {
          if (!this.validateTriggers()) {
            return;
          }
          if (!this.validateAction()) {
            return;
          }
          this.action.params = this.$.actionOptionsCollapse.querySelector('#actionOptions').toJsonObject();
          console.log(this.toJsonObject());
          this.mode = 'summary';
        },

        // Returns the representation of this rule in a JSON-serializable format.
        // Format:
        // {
        //   triggers: [
        //     {
        //       name: 'daily_time',
        //       params: { ... }
        //     }
        //   ],
        //   action: {
        //     name: 'switch_lights',
        //     params: { ... }
        //   }
        // }
        toJsonObject: function() {
          return {
            triggers: this.triggers,
            action: this.action
          };
        },

        validateTriggers: function() {
          var builders = this.$.triggerBuilders.querySelectorAll('trigger-builder');
          for(var i=0; i<builders.length; ++i) {
            var trigger = builders[i];
            var vr = trigger.validate();
            if (!vr.isValid) {
              alert(vr.message);
              return false;
            }
          }
          return true;
        },

        validateAction: function() {
          var action = this.$.actionOptionsCollapse.querySelector('#actionOptions');
          var vr = action.validate();
          if (!vr.isValid) {
            alert(vr.message);
            return false;
          }
          return true;
        },

        delete: function() {
          this.fire('delete-rule', {index: this.index});
        },

        TRIGGER_MODELS: [
          {
            key: 'daily_time',
            displayName: 'Daily time',
            description: 'Makes your rule run every day at a certain time, or between two times.'
          },
          {
            key: 'weather',
            displayName: 'Weather',
            description: 'Makes your rule run when the outside temperature is in some range, or if some condition like rain occurs.'
          },
          {
            key: 'doorbell_rings',
            displayName: 'Doorbell rings',
            description: 'Makes your rule run when the doorbell rings in your house.'
          },
          {
            key: 'my_location',
            displayName: 'My location',
            description: 'Makes your rule run when you arrive, leave, or are currently at home or work.'
          },
        ],
        ACTION_MODELS: [
          {
            key: 'switch_lights',
            displayName: 'Switch lights',
            description: 'Switches the lights in your house on or off.'
          },
          {
            key: 'brew_coffee',
            displayName: 'Brew coffee',
            description: 'Brews one or more pots of coffee.'
          },
          {
            key: 'set_thermostat',
            displayName: 'Set thermostat',
            description: 'Sets the thermostat to some temperature.'
          },
          {
            key: 'send_email',
            displayName: 'Send email',
            description: 'Sends an email notification to yourself.'
          },
        ]
      });
    })();
  </script>
</polymer-element>
