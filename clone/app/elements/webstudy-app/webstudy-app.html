<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../../bower_components/font-roboto/roboto.html">

<polymer-element name="webstudy-app" attributes="participantId">
  <template>
    <link rel="stylesheet" href="webstudy-app.css">
    <core-scaffold drawerWidth="300px">
      <core-header-panel navigation flex mode="seamed">
        <core-toolbar id="navheader">Trigger-action programming</core-toolbar>
        <core-ajax
          auto
          id="questionAjax"
          url="/question/{{participantId}}/{{questionNum}}"
          handleAs="json"
          on-core-response="{{handleQuestionResponse}}"
          on-core-error="{{handleError}}"></core-ajax>
        <core-ajax
          id="saveAjax"
          method="POST"
          url="/save"
          handleAs="json"
          contentType="application/json"
          body="{{saveBody}}"
          on-core-response="{{handleSaveResponse}}"
          on-core-error="{{handleError}}"></core-ajax>
        <webstudy-question
          id="questionElement"
          type='error'
          text="{{[]}}"
          options="{{[]}}"
          on-save-question="{{handleSaveQuestion}}"></webstudy-question>
      </core-header-panel>
      <div tool>Page <span id="questionNum">{{questionNum + 1}}</span> of {{totalQuestions}}</div>
      <div class="content">
        <trigger-action-app id="txgapp" rules="{{[]}}"></trigger-action-app>
      </div>
    </core-scaffold>
  </template>
  <script>
    (function () {
      Polymer({
        participantId: '',
        totalQuestions: 10,
        questionNum: 0,
        saveBody: '', // The body of the POST request to /save.

        handleQuestionResponse: function(e, detail, sender) {
          var question = detail.response;
          if (!question) {
            this.setQuestion('error', [], []);
          } else {
            this.setQuestion(question.type, question.text, question.options);
          }
        },

        setQuestion: function(type, text, options) {
          this.$.questionElement.type = type || 'error';
          this.$.questionElement.text = text || [];
          this.$.questionElement.options = options || [];
        },

        validate: function() {
          if (this.$.txgapp.rules.length == 0) {
            return {
              isValid: false,
              message: 'You must add at least one rule.'
            };
          }
          var vr = this.$.txgapp.validate();
          return vr;
        },

        handleSaveQuestion: function(e, detail, sender) {
          var vr = this.validate();
          if (!vr.isValid) {
            alert(vr.message);
            return;
          }
          var program = this.$.txgapp.toJsonObject();
          var data = {
            p: this.participantId,
            q: this.questionNum,
            rules: program,
            selected: detail['selectedOption'] || ''
          };
          this.saveBody = JSON.stringify(data);
          this.$.saveAjax.go()
        },

        handleSaveResponse: function(e, detail, sender) {
          var response = detail.response;
          if (response.state == 'saved') {
            this.questionNum = response.next;
          } else if (response.state == 'end') {
            window.location.href = '/end/' + response.code;
          } else {
            this.setQuestion('error', [response.message], []);
          }
        },

        handleError: function(e, detail, sender) {
          console.error(e);
          console.error(detail);
          console.error(sender);
          this.setQuestion('error', [], []);
        }
      });
    })();
  </script>
</polymer-element>
