<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">

<polymer-element name="rule-list" attributes="rules readOnly">
  <template>
    <link rel="stylesheet" href="rule-list.css">
    <paper-shadow class="listContainer">
      <template if="{{ rules.length == 0 }}">
        <p class="noRules">No rules have been created yet.</p>
      </template>
      <div id="ruleListWrapper">
        <template repeat="{{ rule, index in rules }}">
          <template if="{{rule.mode == 'update' || rule.mode == 'create'}}">
            <paper-shadow z="2" id="openedRule">
              <rule-card mode="{{rule.mode}}" triggers="{{rule.triggers}}" action="{{rule.action}}" name="{{rule.name}}" on-delete-rule="{{deleteRule}}" readOnly="{{readOnly}}"></rule-card>
            </paper-shadow>
          </template>
          <template if="{{rule.mode != 'update' && rule.mode != 'create'}}">
            <rule-card class="summaryCard" index="{{index}}" mode="{{rule.mode}}" triggers="{{rule.triggers}}" action="{{rule.action}}" name="{{rule.name}}" on-click="{{updateRule}}" readOnly="{{readOnly}}" title="Click to edit this rule"></rule-card>
          </template>
        </template>
      </div>
    </paper-shadow>
  </template>
  <script>
    (function () {
      Polymer({
        ready: function () {
        },

        newRule: function() {
          var ruleElems = this.$.ruleListWrapper.querySelectorAll('rule-card');    
          for (var i=0; i<ruleElems.length; ++i) {
            ruleElems[i].mode = 'summary';
          }
          var newRule = {
            triggers: [{}],
            action: {},
            name: '',
            mode: 'create'
          };
          this.rules.unshift(newRule);
        },

        deleteRule: function(e, detail, sender) {
          this.rules.splice(detail.index, 1);
        },

        updateRule: function(e, detail, sender) {
          var ruleElems = this.$.ruleListWrapper.querySelectorAll('rule-card');    
          for (var i=0; i<ruleElems.length; ++i) {
            if (ruleElems[i].mode == 'create') {
              var result = ruleElems[i].saveRule();
              if (!result) {
                return;
              }
            }
            ruleElems[i].mode = 'summary';
          }
          sender.mode = 'update';
        },

        validate: function() {
          var ruleElems = this.$.ruleListWrapper.querySelectorAll('rule-card');    
          for (var i=0; i<ruleElems.length; ++i) {
            var vr = ruleElems[i].validate();
            if (!vr.isValid) {
              return vr;
            }
          }
          return {
            isValid: true
          };
        },

        toJsonObject: function() {
          var result = [];
          var ruleElems = this.$.ruleListWrapper.querySelectorAll('rule-card');    
          for (var i=0; i<ruleElems.length; ++i) {
            result.push(ruleElems[i].toJsonObject());
          }
          return result;
        }
      });
    })();
  </script>
</polymer-element>
